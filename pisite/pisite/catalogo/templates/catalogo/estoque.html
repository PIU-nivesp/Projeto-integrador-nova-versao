{% load static %}

<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedFarma - Ger√™ncia de Estoque</title>

    <script src="https://cdn.jsdelivr.net/gh/PrabothCharith/accessibility-plugin@main/accessibility-menu.min.js"></script>

    <link rel="stylesheet" href="{% static 'catalogo/index_style.css' %}">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <link rel="stylesheet" href="{% static 'catalogo/estoque_style.css' %}">
    
</head>

<body>

    <header class="header">
        
        <div class="top-bar">
            <div class="top-bar-content">
                <span id="current-time"></span>
            </div>
        </div>

        <nav class="navbar">
            <div class="navbar-container">
                <a href="{% url 'index' %}" class="navbar-brand">
                    <img src="{% static 'img/logo.png' %}" alt="MedFarma Logo">
                    <span>MedFarma</span>
                </a>

                <div class="navbar-links-main">
                    <a href="{% url 'index' %}">Home</a>
                    <a href="{% url 'estoque' %}">Ger√™ncia de Estoque</a>
                    <a href="#" onclick="openModal('retiradaModal')">Retirada de Receita</a> 
                    <a href="#">Relat√≥rios</a>
                    <a href="#">Contato</a>
                </div>

                <div class="navbar-icons">
                    <a href="{% url 'inserir' %}" class="nav-icon-link">
                        <img src="https://agenciatrius.com.br/advogadoBhauer/wp-content/uploads/2025/11/armazenamento-de-dados-1.png" alt="Armazenamento">
                    </a>
                    <a href="#" class="nav-icon-link">
                        <img src="https://agenciatrius.com.br/advogadoBhauer/wp-content/uploads/2025/11/alerta-1.png" alt="Alertas">
                    </a>
                    <a href="#" class="nav-icon-link cart-icon">
                        <span>0</span>
                        <img src="https://via.placeholder.com/24/ffffff/000000?text=üõí" alt="Carrinho">
                    </a>
                    <a href="{% url 'logout' %}" class="logout-link">Sair</a>
                </div>
            </div>
        </nav>
    </header>

    <main class="stock-main-content">
        <h1>Painel de Ger√™ncia de Estoque</h1>

        <div class="stock-grid">
            
            <div class="stock-button btn-cadastro" onclick="openModal('cadastroRemedioModal')">
                <i class="icon fas fa-pills"></i>
                <span>Cadastrar Novo Rem√©dio</span>
            </div>
            
            <div class="stock-button btn-lote" onclick="openModal('loteModal')">
                <i class="icon fas fa-boxes"></i>
                <span>Entrada de Novo Lote</span>
            </div>

            <div class="stock-button btn-baixo-estoque" onclick="openModal('baixoEstoqueModal')">
                <i class="icon fas fa-exclamation-triangle"></i>
                <span>Medica√ß√£o com Baixo Estoque</span>
            </div>

            <div class="stock-button btn-vencimento" onclick="openModal('vencimentoModal')">
                <i class="icon fas fa-calendar-times"></i>
                <span>Pr√≥ximos ao Vencimento</span>
            </div>
        </div>
    </main>

    <div id="cadastroRemedioModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('cadastroRemedioModal')">&times;</span>
            <h2>Cadastro de Novo Medicamento</h2>
            
            <div id="authStatusMessage" class="loading-message" style="display:none;"></div>
            
            <p>Insira todos os dados do novo item para registro no sistema.</p>
            <div id="cadastroMessage" class="message-box" style="display:none;"></div>

            <form id="cadastroForm" action="{% url 'cadastro_medicamento' %}" method="POST">
                {% csrf_token %}
                
                <div class="full-width">
                    <label for="nome_comercial">Nome Comercial:</label>
                    <input type="text" id="nome_comercial" name="nome_comercial" required>
                </div>
                
                <div class="full-width">
                    <label for="principio_ativo">Princ√≠pio Ativo:</label>
                    <input type="text" id="principio_ativo" name="principio_ativo" required>
                </div>
                
                <div>
                    <label for="concentracao">Concentra√ß√£o:</label>
                    <input type="text" id="concentracao" name="concentracao" placeholder="Ex: 500mg, 20mg" required>
                </div>
                
                <div>
                    <label for="forma_farmaceutica">Forma Farmac√™utica:</label>
                    <select id="forma_farmaceutica" name="forma_farmaceutica" required>
                        <option value="">Selecione a Forma</option>
                        <option value="comprimido">Comprimido</option>
                        <option value="capsula">C√°psula</option>
                        <option value="solucao">Solu√ß√£o</option>
                        <option value="injetavel">Injet√°vel</option>
                        <option value="pomada">Pomada</option>
                    </select>
                </div>

                <div>
                    <label for="unidade_medida">Unidade de Medida (Estoque):</label>
                    <select id="unidade_medida" name="unidade_medida" required>
                        <option value="">Selecione a Unidade</option>
                        <option value="comprimido">Comprimido</option>
                        <option value="ml">Mililitro</option>
                        <option value="mg">Miligrama</option>
                        <option value="unidade">Unidade (caixa/frasco)</option>
                    </select>
                </div>

                <div>
                    <label for="estoque_minimo">Estoque M√≠nimo (Alerta):</label>
                    <input type="number" id="estoque_minimo" name="estoque_minimo" min="0" value="10" required>
                </div>

                <div class="full-width checkbox-field">
                    <input type="checkbox" id="controlado" name="controlado">
                    <label for="controlado">√â um Medicamento Controlado (Requer Receita Especial)?</label>
                </div>
                
                <div class="full-width">
                    <button type="submit" id="submitCadastro">
                        Cadastrar Medicamento
                    </button>
                </div>
            </form>
        </div>
    </div>


    <div id="retiradaModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('retiradaModal')">&times;</span>
            <h2>Retirada de Receita e Sa√≠da de Estoque</h2>
            <p>Preencha os dados abaixo para registrar a dispensa de medicamento e dar baixa no estoque.</p>
            <form>
                <div>
                    <label for="medicamento_retirada">Medicamento:</label>
                    <select id="medicamento_retirada" required>
                        <option value="">Carregando Medicamentos...</option>
                    </select>
                </div>
                <div>
                    <label for="quantidade_retirada">Quantidade:</label>
                    <input type="number" id="quantidade_retirada" min="1" required>
                </div>
                <div>
                    <label for="receita_numero">N¬∫ da Receita (Se Controlado):</label>
                    <input type="text" id="receita_numero">
                </div>
                <div>
                    <label for="cliente_nome">Nome do Cliente:</label>
                    <input type="text" id="cliente_nome" required>
                </div>
                <div class="full-width">
                    <button type="submit">Registrar Retirada</button>
                </div>
            </form>
            <div id="retiradaMessage" class="message-box" style="display:none;"></div>
        </div>
    </div>

    <div id="loteModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('loteModal')">&times;</span>
            <h2>Entrada de Novo Lote no Estoque</h2>
            <p>Preencha os detalhes para adicionar um novo lote de medicamentos ao seu invent√°rio.</p>
            
            <form id="loteForm" action="{% url 'entrada_lote' %}" method="POST">
                {% csrf_token %}
                <div id="loteMessage" class="message-box" style="display:none;"></div>

                <div>
                    <label for="medicamento_lote">Medicamento:</label>
                    <select id="medicamento_lote" name="medicamento_lote" required>
                        <option value="">Carregando Medicamentos...</option>
                    </select>
                </div>
                <div>
                    <label for="numero_lote">N√∫mero do Lote:</label>
                    <input type="text" id="numero_lote" name="numero_lote" required>
                </div>
                <div>
                    <label for="quantidade_lote">Quantidade Recebida:</label>
                    <input type="number" id="quantidade_lote" name="quantidade_lote" min="1" required>
                </div>
                <div>
                    <label for="data_vencimento">Data de Vencimento:</label>
                    <input type="date" id="data_vencimento" name="data_vencimento" required>
                </div>
                <div class="full-width">
                    <button type="submit" id="submitLote">Adicionar Lote</button>
                </div>
            </form>
        </div>
    </div>

    <div id="baixoEstoqueModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('baixoEstoqueModal')">&times;</span>
            <h2>Alerta de Baixo Estoque</h2>
            <p>Estes medicamentos est√£o abaixo do n√≠vel de seguran√ßa. (Dados Est√°ticos)</p>
            <table>
                <thead>
                    <tr>
                        <th>Medicamento</th>
                        <th>Estoque Atual</th>
                        <th>M√≠nimo Ideal</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Paracetamol 500mg</td>
                        <td>12 caixas</td>
                        <td>30 caixas</td>
                    </tr>
                    <tr>
                        <td>Soro Fisiol√≥gico</td>
                        <td>5 unidades</td>
                        <td>15 unidades</td>
                    </tr>
                    <tr>
                        <td>Omeprazol 20mg</td>
                        <td>8 caixas</td>
                        <td>25 caixas</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="vencimentoModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('vencimentoModal')">&times;</span>
            <h2>Medicamentos Pr√≥ximos ao Vencimento (Pr√≥ximos 60 Dias)</h2>
            <p>Itens que precisam de aten√ß√£o. A cor rosa indica vencimento em menos de 30 dias. (Dados Est√°ticos)</p>
            <table>
                <thead>
                    <tr>
                        <th>Medicamento</th>
                        <th>Lote</th>
                        <th>Vencimento</th>
                        <th>Quantidade</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="vencimento-critico">
                        <td>Vacina Antigripal</td>
                        <td>VAX-1234</td>
                        <td>28/02/2026</td>
                        <td>25 unidades</td>
                    </tr>
                    <tr>
                        <td>Atenolol 50mg</td>
                        <td>ATE-9876</td>
                        <td>15/04/2026</td>
                        <td>40 caixas</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // --- FUN√á√ïES GERAIS DE UI ---

        window.showMessage = function(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (!element) return;
            element.textContent = message;
            element.className = `message-box ${type}`;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 3000);
        }

        window.openModal = function(modalId) {
            document.getElementById(modalId).style.display = 'block';
            // Quando os modais de Retirada ou Lote abrem, carregamos a lista
            if (modalId === 'retiradaModal' || modalId === 'loteModal') {
                loadMedicamentosList();
            }
        }

        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = 'Hora Atual: ' + timeString;
            }
        }

        updateTime();
        setInterval(updateTime, 1000);

        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            });
        }
        
        // --- FUN√á√ïES AJAX/DJANGOS ---

        // Fun√ß√£o para carregar os medicamentos via API Django
        async function loadMedicamentosList() {
            const selectRetirada = document.getElementById('medicamento_retirada');
            const selectLote = document.getElementById('medicamento_lote');

            selectRetirada.innerHTML = '<option value="">Carregando...</option>';
            selectLote.innerHTML = '<option value="">Carregando...</option>';
            
            try {
                // Rota para a nova view Django
                // Nota: Assuma que 'api_medicamentos' est√° configurada no urls.py
                const response = await fetch('{% url "api_medicamentos" %}');
                const data = await response.json();

                if (data.status === 'success') {
                    const medicamentos = data.medicamentos;
                    
                    selectRetirada.innerHTML = '<option value="">Selecione o Medicamento</option>';
                    selectLote.innerHTML = '<option value="">Selecione o Medicamento</option>';

                    if (medicamentos.length === 0) {
                        selectRetirada.innerHTML = '<option value="">Nenhum medicamento cadastrado</option>';
                        selectLote.innerHTML = '<option value="">Nenhum medicamento cadastrado</option>';
                        return;
                    }

                    medicamentos.forEach(med => {
                        const optionRetirada = document.createElement('option');
                        optionRetirada.value = med.id;
                        optionRetirada.textContent = med.nome;
                        selectRetirada.appendChild(optionRetirada);
                        
                        const optionLote = optionRetirada.cloneNode(true);
                        selectLote.appendChild(optionLote);
                    });

                } else {
                    throw new Error(data.message || 'Falha ao buscar lista.');
                }

            } catch (error) {
                console.error("Erro ao carregar medicamentos:", error);
                const errorMessage = 'Erro ao carregar medicamentos. Recarregue a p√°gina.';
                selectRetirada.innerHTML = `<option value="">${errorMessage}</option>`;
                selectLote.innerHTML = `<option value="">${errorMessage}</option>`;
            }
        }


        // Submiss√£o do Formul√°rio de Cadastro
        async function submitCadastroForm(event) {
            event.preventDefault();
            const cadastroForm = document.getElementById('cadastroForm');
            const messageBoxId = 'cadastroMessage';
            
            const formData = new FormData(cadastroForm);
            
            showMessage(messageBoxId, 'Processando cadastro...', 'info');

            try {
                const response = await fetch(cadastroForm.action, {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(messageBoxId, result.message, 'success');
                    cadastroForm.reset();
                    setTimeout(() => closeModal('cadastroRemedioModal'), 2000);
                } else {
                    showMessage(messageBoxId, result.message || 'Erro desconhecido ao cadastrar.', 'error');
                }
            } catch (e) {
                console.error("Erro ao enviar o formul√°rio:", e);
                showMessage(messageBoxId, 'Erro de comunica√ß√£o com o servidor.', 'error');
            }
        }
        
        // Submiss√£o do Formul√°rio de Lote (NOVO)
        async function addNovoLote(event) {
            event.preventDefault();
            const loteForm = document.getElementById('loteForm');
            const messageBoxId = 'loteMessage';

            const formData = new FormData(loteForm);
            
            showMessage(messageBoxId, 'Registrando entrada de lote...', 'info');

            try {
                // Envia os dados para a nova view Django
                const response = await fetch(loteForm.action, {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(messageBoxId, result.message, 'success');
                    loteForm.reset();
                    // Fecha o modal e recarrega a lista
                    setTimeout(() => closeModal('loteModal'), 2000); 
                    loadMedicamentosList(); 
                } else {
                    showMessage(messageBoxId, result.message || 'Erro desconhecido ao registrar o lote.', 'error');
                }
            } catch (e) {
                console.error("Erro ao enviar o formul√°rio de lote:", e);
                showMessage(messageBoxId, 'Erro de comunica√ß√£o com o servidor.', 'error');
            }
        }

        // --- INICIALIZA√á√ÉO E LIGA√á√ÉO DE EVENTOS ---
        document.addEventListener('DOMContentLoaded', () => {
            const cadastroForm = document.getElementById('cadastroForm');
            if (cadastroForm) {
                cadastroForm.addEventListener('submit', submitCadastroForm);
            }
            
            const loteForm = document.getElementById('loteForm');
            if (loteForm) {
                loteForm.addEventListener('submit', addNovoLote);
            }
        });
    </script>

</body>

</html>